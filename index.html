<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ³¨éŸ³ç·´ç¿’</title>
<style>
  body { font-family:"Noto Sans TC","å¾®è»Ÿæ­£é»‘é«”",sans-serif; background:#FFF8E7; text-align:center; padding:20px;}
  h1 { color:#D2691E; margin:0 0 10px;}
  #toolbar { margin:10px 0 16px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;}
  #word { font-size:52px; margin:18px 0;}
  #progress, #score { font-size:18px; margin:6px 0; color:#444;}
  #selected { font-size:32px; margin:14px 0; color:#0a58ca; min-height:38px;}
  #buttons { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:10px 0 18px;}
  .btn { font-size:26px; padding:10px 16px; border-radius:12px; border:none; background:#FFB347; cursor:pointer;}
  .btn:hover { background:#FF8C00;}
  .btn-ghost { background:#fff; border:2px solid #FFB347;}
  #feedback { font-size:26px; margin-top:8px; min-height:32px;}
  .ok { color:#138a36;} .err { color:#c1121f;} .hint { color:#0a58ca;}

  /* ç°¡æ˜“çµç®—é¢æ¿ */
  #overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;}
  #panel{background:#fff;border-radius:16px;max-width:360px;width:90%;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.25);text-align:left;}
  #panel h2{margin:0 0 10px;font-size:22px;color:#333;}
  #panel p{margin:8px 0;color:#444;line-height:1.6;}
  #panel .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px;}
  #panel button{font-size:16px;padding:8px 14px;border-radius:10px;border:none;background:#FFB347;cursor:pointer;}
  #panel button:hover{background:#FF8C00;}
</style>
</head>
<body>
  <h1>æ³¨éŸ³ç·´ç¿’</h1>

  <div id="toolbar">
    <button class="btn" onclick="submitAnswer()">æäº¤</button>
    <button class="btn" onclick="nextWord()">ä¸‹ä¸€é¡Œ</button>
    <button class="btn btn-ghost" onclick="showHint()">æç¤ºé¦–éŸ³</button>
    <button class="btn btn-ghost" onclick="clearSelected()">æ¸…é™¤</button>
    <label style="display:flex;align-items:center;gap:6px;">
      <input type="checkbox" id="ttsToggle" /> ğŸ”ŠèªéŸ³æœ—è®€
    </label>
  </div>

  <div id="progress">ç¬¬ 1 / 10 é¡Œ</div>
  <div id="word">è©èª</div>
  <div id="selected"></div>
  <div id="buttons"></div>
  <div id="feedback"></div>
  <div id="score">é€£çºŒç­”å°ï¼š0ï¼ˆæœ€ä½³ 0ï¼‰ | æ­£ç¢ºç‡ï¼š0%</div>

  <!-- çµç®—é¢æ¿ -->
  <div id="overlay">
    <div id="panel">
      <h2>æœ¬è¼ªçµæŸ ğŸ‰</h2>
      <p id="summary"></p>
      <div class="actions">
        <button onclick="restartRound()">å†ä¾†ä¸€è¼ª</button>
      </div>
    </div>
  </div>

  <!-- é¡Œåº« -->
  <script src="words.js"></script>

<script>
/* ç‹€æ…‹ */
let current = -1;
let selected = [];
let total = 0;           // ç´¯è¨ˆç­”é¡Œï¼ˆè·¨è¼ªï¼‰
let correctCount = 0;    // ç´¯è¨ˆç­”å°
let streak = 0;
let bestStreak = 0;

let roundTotal = 10;     // ä¸€è¼ªé¡Œæ•¸
let roundCount = 0;      // æœ¬è¼ªå·²ç­”
let roundCorrect = 0;

/* å¹²æ“¾ä¾†æºï¼ˆå¯æ“´å……ï¼‰ */
const allSyllables = [
  "ã„…ã„šË™","ã„…ã„šË‹","ã„…ã„šË‡","ã„…ã„š","ã„†ã„šË‹","ã„†ã„š","ã„…ã„›Ë‹",
  "ã„‡ã„š","ã„‡ã„šË™","ã„‡ã„šË‡","ã„‡ã„›","ã„‡ã„§","ã„‡ã„ ",
  "ã„†ã„§ã„¥ËŠ","ã„ã„¨ã„›Ë‡","ã„’ã„§ã„ Ë‡","ã„†ã„¥ËŠ","ã„§ã„¡Ë‡",
  "ã„‰ã„šË‹","ã„…ã„ Ë‹","ã„ã„šË‹","ã„Šã„šË™","ã„Œã„§Ë‡","ã„ã„¨ã„›","ã„’ã„§ã„ ","ã„†ã„¥"
];

/* å·¥å…·ï¼šæŒ‘å¹²æ“¾ï¼ˆåŒè²æ¯æˆ–åŒéŸ»æ¯å„ªå…ˆï¼Œå«é˜²ç„¡é™è¿´åœˆï¼‰ */
function getDistractors(correct) {
  const need = Math.max(3, correct.length * 2);
  const distractors = [];
  const maxTries = 120;
  let tries = 0;

  const firstSet = correct.map(s => s[0]);
  const lastSet  = correct.map(s => s[s.length - 1]);

  while (distractors.length < need && tries < maxTries) {
    tries++;
    const candidate = allSyllables[Math.floor(Math.random() * allSyllables.length)];
    if (!correct.includes(candidate) && !distractors.includes(candidate)) {
      if (firstSet.includes(candidate[0]) || lastSet.includes(candidate[candidate.length - 1])) {
        distractors.push(candidate);
      }
    }
  }
  // è‹¥é‚„ä¸è¶³ï¼Œéš¨æ©Ÿè£œæ»¿
  while (distractors.length < need) {
    const candidate = allSyllables[Math.floor(Math.random() * allSyllables.length)];
    if (!correct.includes(candidate) && !distractors.includes(candidate)) {
      distractors.push(candidate);
    }
  }
  return distractors;
}

/* å‡ºé¡Œï¼šéš¨æ©Ÿä¸”ä¸èˆ‡ç•¶å‰é‡è¤‡ */
function nextWord() {
  selected = [];
  let index;
  do {
    index = Math.floor(Math.random() * words.length);
  } while (index === current && words.length > 1);
  current = index;

  const w = words[current];
  document.getElementById("word").textContent = w.char;
  if (document.getElementById("ttsToggle").checked && "speechSynthesis" in window) {
    const u = new SpeechSynthesisUtterance(w.char);
    u.lang = "zh-TW";
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  document.getElementById("selected").textContent = "";
  document.getElementById("feedback").textContent = "";
  renderOptions();
  updateProgress();
}

/* æ¸²æŸ“é¸é … */
function renderOptions() {
  const btnDiv = document.getElementById("buttons");
  btnDiv.innerHTML = "";
  const correct = words[current].zhuyin;
  let options = [...correct, ...getDistractors(correct)];
  options.sort(() => Math.random() - 0.5);

  options.forEach(symbol => {
    const btn = document.createElement("button");
    btn.textContent = symbol;
    btn.className = "btn";
    btn.onclick = () => { selected.push(symbol); updateSelected(); };
    btnDiv.appendChild(btn);
  });
}

function updateSelected() {
  document.getElementById("selected").textContent = selected.join(" ");
}

function submitAnswer() {
  const ans = selected.join(" ");
  const correct = words[current].zhuyin.join(" ");
  total++;
  roundCount++;

  if (ans === correct) {
    streak++;
    if (streak > bestStreak) bestStreak = streak;
    correctCount++;
    roundCorrect++;
    setFeedback("âœ… æ­£ç¢ºï¼", "ok");
    // è‡ªå‹•ä¸‹ä¸€é¡Œ
    if (roundCount >= roundTotal) {
      setTimeout(showSummary, 500);
    } else {
      setTimeout(nextWord, 800);
    }
  } else {
    streak = 0;
    setFeedback(`âŒ éŒ¯èª¤ï¼Œæ­£ç¢ºç­”æ¡ˆï¼š${correct}`, "err");
  }
  updateScore();
  updateProgress();

  if (roundCount >= roundTotal && ans !== correct) {
    // è‹¥æœ€å¾Œä¸€é¡Œç­”éŒ¯ä¹Ÿè¦çµç®—
    setTimeout(showSummary, 500);
  }
}

function setFeedback(text, type) {
  const el = document.getElementById("feedback");
  el.textContent = text;
  el.className = type === "ok" ? "ok" : (type === "hint" ? "hint" : "err");
}

function showHint() {
  setFeedback(`æç¤ºé¦–å€‹æ³¨éŸ³ï¼š${words[current].zhuyin[0]}`, "hint");
}

function clearSelected() {
  selected = [];
  updateSelected();
  setFeedback("", "");
}

function updateScore() {
  const rate = total > 0 ? Math.round((correctCount / total) * 100) : 0;
  document.getElementById("score").textContent =
    `é€£çºŒç­”å°ï¼š${streak}ï¼ˆæœ€ä½³ ${bestStreak}ï¼‰ | æ­£ç¢ºç‡ï¼š${rate}%`;
}

function updateProgress() {
  document.getElementById("progress").textContent = `ç¬¬ ${Math.min(roundCount + 1, roundTotal)} / ${roundTotal} é¡Œ`;
}

/* çµç®—é¢æ¿ */
function showSummary() {
  const rate = roundCount > 0 ? Math.round((roundCorrect / roundCount) * 100) : 0;
  document.getElementById("summary").textContent =
    `æœ¬è¼ªæˆç¸¾ï¼š${roundCorrect} / ${roundCount} é¡Œï¼Œæ­£ç¢ºç‡ ${rate}%ã€‚\næœ€é•·é€£æ“Šï¼ˆæœ¬è¼ªå¤–ç´¯è¨ˆï¼‰ï¼š${bestStreak}`;
  document.getElementById("overlay").style.display = "flex";
}

function restartRound() {
  roundCount = 0;
  roundCorrect = 0;
  document.getElementById("overlay").style.display = "none";
  nextWord();
}

/* åˆå§‹åŒ– */
nextWord();
updateScore();
</script>
</body>
</html>

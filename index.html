<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>注音練習</title>

<link rel="preload" as="font" href="BpmfIansui-Regular.ttf" type="font/ttf" crossorigin>
<link rel="preload" as="font" href="Iansui-Regular.ttf" type="font/ttf" crossorigin>

<style>
  @font-face {
    font-family: 'BpmfIansui';
    src: url('BpmfIansui-Regular.ttf') format('truetype');
    font-display: swap;
  }
  @font-face {
    font-family: 'Iansui';
    src: url('Iansui-Regular.ttf') format('truetype');
    font-display: swap;
  }

  body {
    font-family:'BpmfIansui',"Noto Sans TC",sans-serif;
    background:linear-gradient(180deg,#E6F0FF 0%,#F7FAFF 100%);
    text-align:center;
    padding:20px;
    color:#1A365D;
  }

  #wordText {
    font-family:'Iansui',"Noto Sans TC",sans-serif !important;
    font-size:72px;
    text-shadow:1px 1px 2px rgba(0,0,0,0.15);
  }

  #buttons button,
  #selected,
  #feedback,
  #progress,
  .btn,
  #toolbar button {
    font-family:'BpmfIansui','Noto Sans TC','PingFang TC',sans-serif !important;
  }

  h1 { color:#1E40AF; margin:0 0 10px; text-shadow:1px 1px 2px rgba(0,0,0,0.05);}
  #toolbar { margin:10px 0 16px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;}
  #word { margin:18px 0; display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap;}
  #progress { font-size:18px; margin:6px 0; color:#2563EB;}
  #selected { font-size:32px; margin:14px 0; color:#1D4ED8; min-height:38px;}
  #buttons { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:10px 0 18px;}

  .btn {
    font-size:26px;
    padding:10px 16px;
    border-radius:12px;
    border:none;
    background:linear-gradient(145deg,#3B82F6,#2563EB);
    color:#fff;
    cursor:pointer;
    box-shadow:0 4px 10px rgba(37,99,235,0.3);
    transition:transform 0.1s, box-shadow 0.2s;
  }
  .btn:hover { transform:translateY(-2px); box-shadow:0 6px 14px rgba(37,99,235,0.4);}
  .btn-ghost {
    background:#fff;
    border:2px solid #3B82F6;
    color:#1E40AF;
    box-shadow:none;
  }
  .btn-ghost:hover { background:#DBEAFE; }
  #feedback { font-size:26px; margin-top:8px; min-height:32px;}
  .ok { color:#059669; } .err { color:#DC2626; }

  #overlay{
    position:fixed;inset:0;background:rgba(0,0,0,.4);
    display:none;align-items:center;justify-content:center;
  }
  #panel{
    background:#fff;
    border-radius:16px;
    max-width:360px;
    width:90%;
    padding:22px;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
    text-align:left;
  }
  #panel h2{margin:0 0 10px;font-size:22px;color:#1E3A8A;}
  #panel p{margin:8px 0;color:#1E40AF;line-height:1.6;white-space:pre-line;}

  #panel .actions {
    display:flex;
    flex-wrap:nowrap;
    justify-content:center;
    gap:20px;
    margin-top:18px;
  }

  #panel button {
    font-family:'BpmfIansui','Noto Sans TC','PingFang TC',sans-serif !important;
    font-size:20px;
    padding:12px 20px;
    border-radius:12px;
    border:none;
    background:linear-gradient(145deg,#3B82F6,#2563EB);
    color:#fff;
    cursor:pointer;
    box-shadow:0 4px 10px rgba(37,99,235,0.3);
    transition:transform 0.12s, box-shadow 0.2s;
    min-width:150px;
  }

  #panel button:hover {
    transform:translateY(-3px);
    box-shadow:0 8px 16px rgba(37,99,235,0.45);
  }
</style>
</head>

<body>
  <h1>注音練習</h1>

  <div id="toolbar">
    <button class="btn" onclick="submitAnswer()">送出</button>
    <button class="btn" onclick="nextWord()">下一題</button>
    <button class="btn btn-ghost" onclick="clearSelected()">清除</button>
    <button class="btn" onclick="startChallenge()">🚀 挑戰模式</button>
  </div>

  <div id="progress">自由練習</div>

  <div id="word">
    <span id="wordText">詞語</span>
    <button id="playBtn" class="btn btn-ghost" onclick="playTTS()">🔊 再聽一次</button>
  </div>

  <div id="selected"></div>
  <div id="buttons"></div>
  <div id="feedback"></div>

  <script src="words.js"></script>
  <script src="zhuyin-all.js"></script>

<script>
let current = -1;
let selected = [];
let isChallenge = false;
const ROUND_TOTAL = 10;
let roundCount = 0, roundCorrect = 0;

function getDistractors(correct) {
  const need = Math.max(3, correct.length * 2);
  const distractors = [];
  while (distractors.length < need) {
    const c = allSyllables[Math.floor(Math.random() * allSyllables.length)];
    if (!correct.includes(c) && !distractors.includes(c)) distractors.push(c);
  }
  return distractors;
}

function nextWord() {
  selected = [];
  let idx;
  do { idx = Math.floor(Math.random() * words.length); } while (idx === current);
  current = idx;
  const w = words[current];
  document.getElementById("wordText").textContent = w.char;
  document.getElementById("selected").textContent = "";
  document.getElementById("feedback").textContent = "";
  updateProgressText();
  renderOptions();
  playTTS();
}

function updateProgressText() {
  if (isChallenge) {
    const shown = Math.min(roundCount + 1, ROUND_TOTAL);
    document.getElementById("progress").textContent = `挑戰模式：第 ${shown} / ${ROUND_TOTAL} 題`;
  } else document.getElementById("progress").textContent = "自由練習";
}

function renderOptions() {
  const btnDiv = document.getElementById("buttons");
  btnDiv.innerHTML = "";
  const correct = words[current].zhuyin;
  let options = [...correct, ...getDistractors(correct)];
  options.sort(() => Math.random() - 0.5);
  options.forEach(syl => {
    const btn = document.createElement("button");
    btn.textContent = syl;
    btn.className = "btn";
    btn.onclick = () => { selected.push(syl); document.getElementById("selected").textContent = selected.join(" "); };
    btnDiv.appendChild(btn);
  });
}

function submitAnswer() {
  if (!words[current]) return;
  if (selected.length === 0) { setFeedback("先選注音再送出喔～","hint"); return; }
  const ans = selected.join(" ");
  const correct = words[current].zhuyin.join(" ");
  if (isChallenge) {
    roundCount++;
    if (ans === correct) { 
      roundCorrect++; 
      setFeedback("✅ 正確！","ok"); 
      setTimeout(nextWord, 3000);
    }
    else {
      setFeedback(`❌ 錯誤，正確答案：${correct}`,"err");
      setTimeout(nextWord, 3000);
    }
    if (roundCount >= ROUND_TOTAL) setTimeout(showChallengeSummary, 600);
  } else {
    if (ans === correct) { 
      setFeedback("✅ 正確！","ok"); 
      setTimeout(nextWord, 3000);
    }
    else setFeedback(`❌ 錯誤，正確答案：${correct}`,"err");
  }
}

function startChallenge() {
  isChallenge = true;
  roundCount = 0; roundCorrect = 0;
  setFeedback("🚀 挑戰開始！共 10 題","ok");
  nextWord();
}

function showChallengeSummary() {
  const rate = Math.round((roundCorrect / ROUND_TOTAL) * 100);
  const msg = `本輪成績：${roundCorrect} / ${ROUND_TOTAL}\n正確率：${rate}%\n做得好！再挑戰一次吧～`;
  document.getElementById("summary").textContent = msg;
  document.getElementById("overlay").style.display = "flex";
}

function restartRound() {
  isChallenge = true;
  roundCount = 0;
  roundCorrect = 0;
  document.getElementById("overlay").style.display = "none";
  nextWord();
}

function setFeedback(t,cls){const e=document.getElementById("feedback");e.textContent=t;e.className=cls;}
function clearSelected(){ selected=[]; document.getElementById("selected").textContent=""; setFeedback("",""); }
function playTTS(){
  const w = words[current]; if (!w) return;
  if ("speechSynthesis" in window) {
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(w.char);
    u.lang = "zh-TW";
    speechSynthesis.speak(u);
  }
}
nextWord();
</script>

<div id="overlay">
  <div id="panel">
    <h2>挑戰結束 🎉</h2>
    <p id="summary"></p>
    <div class="actions">
      <button onclick="restartRound()">再挑戰一次</button>
      <button onclick="(document.getElementById('overlay').style.display='none', isChallenge=false, setFeedback('回到自由練習','ok'), updateProgressText())">返回自由練習</button>
    </div>
  </div>
</div>

</body>
</html>
